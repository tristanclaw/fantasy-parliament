# Security Review: Fantasy Parliament "Join the Season"

**Date:** 2026-02-13
**Reviewer:** Security Engineer Subagent
**Status:** ‚ùå FAIL

## Executive Summary
The "Join the Season" feature contains **Critical** logical and validation vulnerabilities. The current implementation allows users to cheat by registering oversized teams, use invalid data, and relies on an insecure client-side identity mechanism.

## üö® Critical Vulnerabilities

### 1. Missing Gameplay Validation (Cheat Risk)
**Location:** `main.py` (`/api/register`)
**Issue:** The backend trusts the `RegistrationRequest` payload blindly.
- **Team Size:** No check on `team_mp_ids` length. A user can register 100 MPs to guarantee a win.
- **MP Validity:** No check that `captain_mp_id` or `team_mp_ids` actually exist in the `MP` table.
- **Duplicates:** A user can select the highest-scoring MP five times (e.g., `[1, 1, 1, 1]`).
**Remediation:**
Add validation logic in `/api/register`:
```python
# Pseudo-code
if len(registration.team_mp_ids) != 4:
    raise HTTPException(400, "Team must have exactly 4 members")
if len(set(registration.team_mp_ids)) != 4:
    raise HTTPException(400, "Duplicate MPs not allowed")
# Verify IDs exist in DB
valid_ids = select(m.id for m in MP if m.id in registration.team_mp_ids)[:]
if len(valid_ids) != 4:
    raise HTTPException(400, "Invalid MP IDs provided")
```

### 2. Insecure Identity / Account Takeover Risk
**Location:** `frontend/src/components/MyTeam.jsx` & `main.py`
**Issue:** `user_id` is generated by the client (`Math.random()`) and stored in `localStorage`.
- **Fragility:** If a user clears cache/changes browsers, they lose their team forever.
- **Spoofing:** A malicious user can interact with the API directly and claim any `user_id`.
**Remediation:**
- **Short term:** Generate `user_id` (UUID) on the *Backend* upon first registration and return it (checking for collisions).
- **Long term:** Implement proper Auth (OAuth/Email Magic Link).

## ‚ö†Ô∏è High/Medium Risks

### 3. Lack of Input Sanitization (Stored XSS Potential)
**Location:** `models.py`, `main.py`
**Issue:** `display_name` and `team_name` are stored raw. While React escapes output, other clients or future admin dashboards might not.
**Remediation:**
- Enforce character limits (e.g., max 50 chars).
- Strip HTML tags or use a library like `bleach` (if Python side) or rely on strict Content-Security-Policy.

### 4. Unverified Emails
**Location:** `main.py`
**Issue:** No email verification is performed. Users can register with `prime.minister@canada.ca`.
**Remediation:**
- Integrate an email service (SendGrid/AWS SES) to send a "Verify your team" link. Only activate the registration after click.

## ‚úÖ Recommendations for Fix

1.  **Update `RegistrationRequest` in `main.py`:**
    - Add `import Pydantic` validators.
    - Validate `email` using `EmailStr`.
    - Enforce `str` constraints (min_length, max_length).

2.  **Implement Logic Check in `/api/register`:**
    - Fetch selected MPs from DB to verify existence.
    - Ensure Captain is valid.
    - Ensure Team Count == 4 (or defined rule).
    - Ensure No Duplicates.

3.  **Refactor ID Generation:**
    - Remove ID generation from Frontend.
    - Backend should generate `uuid4()` if not provided (or force new session creation).

**Verdict:** ‚ùå **FAIL** - Do not deploy until Validation Logic (Point 1) is fixed.
